var Diablo=function(){var n=typeof document!="undefined"&&document.currentScript?document.currentScript.src:undefined;return typeof __filename!="undefined"&&(n=n||__filename),function(t){function pr(n){return i.locateFile?i.locateFile(n,o):o+n}function wi(n,t){n||v("Assertion failed: "+t)}function bi(n,t,i){for(var h=t+i,u=t,f,r,e,o,s;n[u]&&!(u>=h);)++u;if(u-t>16&&n.subarray&&gt)return gt.decode(n.subarray(t,u));for(f="";t<u;){if(r=n[t++],!(r&128)){f+=String.fromCharCode(r);continue}if(e=n[t++]&63,(r&224)==192){f+=String.fromCharCode((r&31)<<6|e);continue}o=n[t++]&63;r=(r&240)==224?(r&15)<<12|e<<6|o:(r&7)<<18|e<<12|o<<6|n[t++]&63;r<65536?f+=String.fromCharCode(r):(s=r-65536,f+=String.fromCharCode(55296|s>>10,56320|s&1023))}return f}function ct(n,t){return n?bi(u,n,t):""}function kr(n,t){return n%t>0&&(n+=t-n%t),n}function nr(n){ki=n;i.HEAP8=g=new Int8Array(n);i.HEAP16=dr=new Int16Array(n);i.HEAP32=r=new Int32Array(n);i.HEAPU8=u=new Uint8Array(n);i.HEAPU16=gr=new Uint16Array(n);i.HEAPU32=nu=new Uint32Array(n);i.HEAPF32=di=new Float32Array(n);i.HEAPF64=gi=new Float64Array(n)}function ru(){if(i.preRun)for(typeof i.preRun=="function"&&(i.preRun=[i.preRun]);i.preRun.length;)ou(i.preRun.shift());ti(tr)}function uu(){tu=!0;ti(ir)}function fu(){iu=!0}function eu(){if(i.postRun)for(typeof i.postRun=="function"&&(i.postRun=[i.postRun]);i.postRun.length;)ur(i.postRun.shift());ti(rr)}function ou(n){tr.unshift(n)}function su(n){ir.unshift(n)}function ur(n){rr.unshift(n)}function hu(){a++;i.monitorRunDependencies&&i.monitorRunDependencies(a)}function cu(){if(a--,i.monitorRunDependencies&&i.monitorRunDependencies(a),a==0&&(ni!==null&&(clearInterval(ni),ni=null),nt)){var n=nt;nt=null;n()}}function v(n){if(i.onAbort)i.onAbort(n);n+="";l(n);ht=!0;pi=1;n="abort("+n+"). Build with -s ASSERTIONS=1 for more info.";var t=new WebAssembly.RuntimeError(n);pt(t);throw t;}function er(n){return n.startsWith(fr)}function or(n){return n.startsWith("file://")}function sr(n){try{if(n==e&&d)return new Uint8Array(d);if(k)return k(n);throw"both async and sync fetching of the wasm failed";}catch(t){v(t)}}function lu(){if(!d&&(et||c))if(typeof fetch!="function"||or(e)){if(bt)return new Promise(function(n,t){bt(e,function(t){n(new Uint8Array(t))},t)})}else return fetch(e,{credentials:"same-origin"}).then(function(n){if(!n.ok)throw"failed to load wasm binary file at '"+e+"'";return n.arrayBuffer()}).catch(function(){return sr(e)});return Promise.resolve().then(function(){return sr(e)})}function au(){function r(n){var t=n.exports;i.asm=t;st=i.asm.U;nr(st.buffer);w=i.asm.W;su(i.asm.V);cu("wasm-instantiate")}function t(n){r(n.instance)}function u(t){return lu().then(function(t){return WebAssembly.instantiate(t,n)}).then(t,function(n){l("failed to asynchronously prepare wasm: "+n);v(n)})}function f(){return d||typeof WebAssembly.instantiateStreaming!="function"||er(e)||or(e)||typeof fetch!="function"?u(t):fetch(e,{credentials:"same-origin"}).then(function(i){var r=WebAssembly.instantiateStreaming(i,n);return r.then(t,function(n){return l("wasm streaming compile failed: "+n),l("falling back to ArrayBuffer instantiation"),u(t)})})}var n={a:de};if(hu("wasm-instantiate"),i.instantiateWasm)try{return i.instantiateWasm(n,r)}catch(o){return l("Module.instantiateWasm callback failed with error: "+o),!1}return f().catch(pt),{}}function vu(){self.DApi.close_keyboard()}function yu(n,t,i,r,u){self.DApi.open_keyboard(n,t,i,r,u)}function pu(n,t,i){self.DApi.create_sound(n,u.slice(t,t+i))}function wu(n,t,i,r,u){self.DApi.create_sound_raw(n,di.slice(t/4,t/4+i*r),i,r,u)}function bu(n){self.DApi.delete_sound(n)}function ku(){self.DApi.draw_begin()}function du(n){self.DApi.draw_belt(r.subarray(n/4,n/4+8))}function gu(n,t,i,r,f){self.DApi.draw_blit(n,t,i,r,u.subarray(f,f+i*r*4))}function nf(n,t,i,r){self.DApi.draw_clip_text(n,t,i,r)}function tf(){self.DApi.draw_end()}function rf(n,t,i,r){var f=u.indexOf(0,i),e=String.fromCharCode.apply(null,u.subarray(i,f));self.DApi.draw_text(n,t,e,r)}function uf(n,t){self.DApi.duplicate_sound(n,t)}function ff(){self.DApi.exit_game()}function ef(n,t,i,r){self.DApi.play_sound(n,t,i,r)}function of(n,t){self.DApi.set_cursor(n,t)}function sf(n,t){self.DApi.set_volume(n,t)}function hf(n){self.DApi.stop_sound(n)}function cf(n){self.DApi.use_websocket(n)}function lf(){return self.DApi.websocket_closed()}function af(n,t){self.DApi.websocket_send(u.subarray(n,n+t))}function vf(n){var t=u.indexOf(0,n),i=String.fromCharCode.apply(null,u.subarray(n,t));self.DApi.exit_error(i)}function yf(n,t,i,r){var f=u.indexOf(0,n),e=String.fromCharCode.apply(null,u.subarray(n,f));self.DApi.get_file_contents(e,u.subarray(t,t+r),i)}function pf(n){var t=u.indexOf(0,n),i=String.fromCharCode.apply(null,u.subarray(n,t));return self.DApi.get_file_size(i)}function wf(n,t,i){var r=u.indexOf(0,n),f=String.fromCharCode.apply(null,u.subarray(n,r));self.DApi.put_file_contents(f,u.slice(t,t+i))}function bf(n){var t=u.indexOf(0,n),i=String.fromCharCode.apply(null,u.subarray(n,t));self.DApi.remove_file(i)}function ti(n){for(var t,r;n.length>0;){if(t=n.shift(),typeof t=="function"){t(i);continue}r=t.func;typeof r=="number"?t.arg===undefined?w.get(r)():w.get(r)(t.arg):r(t.arg===undefined?null:t.arg)}}function lr(){return yi||cr>0}function kf(n,t,i,r){v("Assertion failed: "+ct(n)+", at: "+[t?ct(t):"unknown filename",i,r?ct(r):"unknown function"])}function df(n){return fi(n+f.SIZE)+f.SIZE}function tt(n){this.excPtr=n;this.ptr=n-f.SIZE;this.set_type=function(n){r[this.ptr+f.TYPE_OFFSET>>2]=n};this.get_type=function(){return r[this.ptr+f.TYPE_OFFSET>>2]};this.set_destructor=function(n){r[this.ptr+f.DESTRUCTOR_OFFSET>>2]=n};this.get_destructor=function(){return r[this.ptr+f.DESTRUCTOR_OFFSET>>2]};this.set_refcount=function(n){r[this.ptr+f.REFCOUNT_OFFSET>>2]=n};this.set_caught=function(n){n=n?1:0;g[this.ptr+f.CAUGHT_OFFSET>>0]=n};this.get_caught=function(){return g[this.ptr+f.CAUGHT_OFFSET>>0]!=0};this.set_rethrown=function(n){n=n?1:0;g[this.ptr+f.RETHROWN_OFFSET>>0]=n};this.get_rethrown=function(){return g[this.ptr+f.RETHROWN_OFFSET>>0]!=0};this.init=function(n,t){this.set_type(n);this.set_destructor(t);this.set_refcount(0);this.set_caught(!1);this.set_rethrown(!1)};this.add_ref=function(){var n=r[this.ptr+f.REFCOUNT_OFFSET>>2];r[this.ptr+f.REFCOUNT_OFFSET>>2]=n+1};this.release_ref=function(){var n=r[this.ptr+f.REFCOUNT_OFFSET>>2];return r[this.ptr+f.REFCOUNT_OFFSET>>2]=n-1,n===1}}function lt(n){this.free=function(){ui(this.ptr);this.ptr=0};this.set_base_ptr=function(n){r[this.ptr>>2]=n};this.get_base_ptr=function(){return r[this.ptr>>2]};this.set_adjusted_ptr=function(n){r[this.ptr+4>>2]=n};this.get_adjusted_ptr=function(){return r[this.ptr+4>>2]};this.get_exception_ptr=function(){var t=vr(this.get_exception_info().get_type()),n;return t?r[this.get_base_ptr()>>2]:(n=this.get_adjusted_ptr(),n!==0)?n:this.get_base_ptr()};this.get_exception_info=function(){return new tt(this.get_base_ptr())};n===undefined?(this.ptr=fi(8),this.set_adjusted_ptr(0)):this.ptr=n}function gf(n){n.add_ref()}function ne(n){var i=new lt(n),t=i.get_exception_info();return t.get_caught()||(t.set_caught(!0),ri--),t.set_rethrown(!1),ii.push(i),gf(t),i.get_exception_ptr()}function ar(n){return ui(new tt(n).ptr)}function te(n){if(n.release_ref()&&!n.get_rethrown()){var t=n.get_destructor();t&&w.get(t)(n.excPtr);ar(n.excPtr)}}function ie(){vt(0);var n=ii.pop();te(n.get_exception_info());n.free();y=0}function re(n){var t=new lt(n),i=t.get_base_ptr();y||(y=i);t.free();throw i;}function ue(){var n=y,f,i,o;if(!n)return h(0),0;var c=new tt(n),u=c.get_type(),t=new lt;if(t.set_base_ptr(n),!u)return h(0),t.ptr|0;var s=Array.prototype.slice.call(arguments),l=rt(),e=ei(4);for(r[e>>2]=n,f=0;f<s.length;f++){if(i=s[f],i===0||i===u)break;if(oi(i,u,e))return o=r[e>>2],n!==o&&t.set_adjusted_ptr(o),h(i),t.ptr|0}return ut(l),h(u),t.ptr|0}function fe(){var n=y,f,i,o;if(!n)return h(0),0;var c=new tt(n),u=c.get_type(),t=new lt;if(t.set_base_ptr(n),!u)return h(0),t.ptr|0;var s=Array.prototype.slice.call(arguments),l=rt(),e=ei(4);for(r[e>>2]=n,f=0;f<s.length;f++){if(i=s[f],i===0||i===u)break;if(oi(i,u,e))return o=r[e>>2],n!==o&&t.set_adjusted_ptr(o),h(i),t.ptr|0}return ut(l),h(u),t.ptr|0}function ee(n,t,i){var r=new tt(n);r.init(t,i);y=n;ri++;throw n;}function oe(){v()}function se(n,t){var f,i;for(at.length=0,t>>=2;f=u[n++];)i=f<105,i&&t&1&&t++,at.push(i?gi[t++>>1]:r[t]),++t;return at}function he(n,t,i){var r=se(t,i);return hr[n].apply(null,r)}function ce(n,t,i){u.copyWithin(n,t,t+i)}function le(n){try{return st.grow(n-ki.byteLength+65535>>>16),nr(st.buffer),1}catch(t){}}function ae(n){var o=u.length,r,t,i,f,e;if(n=n>>>0,r=2147483648,n>r)return!1;for(t=1;t<=4;t*=2)if(i=o*(1+.2/t),i=Math.min(i,n+100663296),f=Math.min(r,kr(Math.max(n,i),65536)),e=le(f),e)return!0;return!1}function ve(n){vo(n)}function ye(){return 0}function pe(){}function we(n,t,i,f){for(var c,s,o,h=0,e=0;e<i;e++){for(c=r[t+e*8>>2],s=r[t+(e*8+4)>>2],o=0;o<s;o++)it.printChar(n,u[c+o]);h+=s}return r[f>>2]=h,0}function be(){return br()}function ke(n){var t=Date.now()/1e3|0;return n&&(r[n>>2]=t),t}function co(n,t,i){var u=rt();try{return w.get(n)(t,i)}catch(r){if(ut(u),r!==r+0&&r!=="longjmp")throw r;vt(1,0)}}function lo(n){var i=rt();try{w.get(n)()}catch(t){if(ut(i),t!==t+0&&t!=="longjmp")throw t;vt(1,0)}}function yr(n){this.name="ExitStatus";this.message="Program terminated with exit("+n+")";this.status=n}function si(n){function t(){yt||(yt=!0,i.calledRun=!0,ht)||(uu(),hi(i),i.onRuntimeInitialized&&i.onRuntimeInitialized(),eu())}(n=n||b,a>0)||(ru(),a>0)||(i.setStatus?(i.setStatus("Running..."),setTimeout(function(){setTimeout(function(){i.setStatus("")},1);t()},1)):t())}function vo(n,t){if(pi=n,!t||!lr()||n!==0){if(!lr()){if(fu(),i.onExit)i.onExit(n);ht=!0}ft(n,new yr(n))}}var i,hi,pt,p,s,o,ot,bt,k,wr,kt,dt,ai,l,yi,st,ht,pi,gt,ki,g,u,dr,gr,r,nu,di,gi,fr,e,hr,cr,f,ii,ri,y,at,it,yt;t=t||{};i=typeof t!="undefined"?t:{};i.ready=new Promise(function(n,t){hi=n;pt=t});p={};for(s in i)i.hasOwnProperty(s)&&(p[s]=i[s]);var b=[],ci="./this.program",ft=function(n,t){throw t;},et=!1,c=!1,wt=!1,li=!1;if(et=typeof window=="object",c=typeof importScripts=="function",wt=typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string",li=!et&&!wt&&!c,o="",wt){o=c?require("path").dirname(o)+"/":__dirname+"/";ot=function(n,t){return kt||(kt=require("fs")),dt||(dt=require("path")),n=dt.normalize(n),kt.readFileSync(n,t?null:"utf8")};k=function(n){var t=ot(n,!0);return t.buffer||(t=new Uint8Array(t)),wi(t.buffer),t};process.argv.length>1&&(ci=process.argv[1].replace(/\\/g,"/"));b=process.argv.slice(2);process.on("uncaughtException",function(n){if(!(n instanceof yr))throw n;});process.on("unhandledRejection",v);ft=function(n){process.exit(n)};i.inspect=function(){return"[Emscripten Module object]"}}else li?(typeof read!="undefined"&&(ot=function(n){return read(n)}),k=function(n){var t;return typeof readbuffer=="function"?new Uint8Array(readbuffer(n)):(t=read(n,"binary"),wi(typeof t=="object"),t)},typeof scriptArgs!="undefined"?b=scriptArgs:typeof arguments!="undefined"&&(b=arguments),typeof quit=="function"&&(ft=function(n){quit(n)}),typeof print!="undefined"&&(typeof console=="undefined"&&(console={}),console.log=print,console.warn=console.error=typeof printErr!="undefined"?printErr:print)):(et||c)&&(c?o=self.location.href:typeof document!="undefined"&&document.currentScript&&(o=document.currentScript.src),n&&(o=n),o=o.indexOf("blob:")!==0?o.substr(0,o.lastIndexOf("/")+1):"",ot=function(n){var t=new XMLHttpRequest;return t.open("GET",n,!1),t.send(null),t.responseText},c&&(k=function(n){var t=new XMLHttpRequest;return t.open("GET",n,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)}),bt=function(n,t,i){var r=new XMLHttpRequest;r.open("GET",n,!0);r.responseType="arraybuffer";r.onload=function(){if(r.status==200||r.status==0&&r.response){t(r.response);return}i()};r.onerror=i;r.send(null)},wr=function(n){document.title=n});ai=i.print||console.log.bind(console);l=i.printErr||console.warn.bind(console);for(s in p)p.hasOwnProperty(s)&&(i[s]=p[s]);p=null;i.arguments&&(b=i.arguments);i.thisProgram&&(ci=i.thisProgram);i.quit&&(ft=i.quit);var vi=0,h=function(n){vi=n},br=function(){return vi},d;i.wasmBinary&&(d=i.wasmBinary);yi=i.noExitRuntime||!0;typeof WebAssembly!="object"&&v("no native wasm support detected");ht=!1;gt=typeof TextDecoder!="undefined"?new TextDecoder("utf8"):undefined;var po=i.INITIAL_MEMORY||134217728,w,tr=[],ir=[],rr=[],tu=!1,iu=!1;var a=0,ni=null,nt=null;i.preloadedImages={};i.preloadedAudios={};fr="data:application/octet-stream;base64,";e="Diablo.wasm";er(e)||(e=pr(e));hr={273866:function(n){self.DApi.current_save_id(n)}};cr=0;f={DESTRUCTOR_OFFSET:0,REFCOUNT_OFFSET:4,TYPE_OFFSET:8,CAUGHT_OFFSET:12,RETHROWN_OFFSET:13,SIZE:16};ii=[];ri=0;y=0;at=[];it={mappings:{},buffers:[null,[],[]],printChar:function(n,t){var i=it.buffers[n];t===0||t===10?((n===1?ai:l)(bi(i,0)),i.length=0):i.push(t)},varargs:undefined,get:function(){it.varargs+=4;return r[it.varargs-4>>2]},getStr:function(n){return ct(n)},get64:function(n){return n}};var de={v:kf,e:df,A:ne,z:ie,i:ue,l:fe,p:ar,d:ee,h:re,H:vu,I:yu,F:oe,L:pu,O:wu,a:bu,u:ku,P:du,t:gu,S:nf,k:tf,R:rf,M:uf,G:ff,r:ef,Q:of,K:sf,N:hf,m:cf,D:lf,E:af,J:he,x:ce,y:ae,b:ve,o:vf,C:ye,w:pe,q:we,c:be,f:yf,s:pf,j:co,B:lo,g:wf,T:bf,n:ke},wo=au(),ge=i.___wasm_call_ctors=function(){return(ge=i.___wasm_call_ctors=i.asm.V).apply(null,arguments)},ui=i._free=function(){return(ui=i._free=i.asm.X).apply(null,arguments)},fi=i._malloc=function(){return(fi=i._malloc=i.asm.Y).apply(null,arguments)},no=i._DApi_SyncTextPtr=function(){return(no=i._DApi_SyncTextPtr=i.asm.Z).apply(null,arguments)},to=i._DApi_Init=function(){return(to=i._DApi_Init=i.asm._).apply(null,arguments)},io=i._DApi_Mouse=function(){return(io=i._DApi_Mouse=i.asm.$).apply(null,arguments)},ro=i._DApi_Key=function(){return(ro=i._DApi_Key=i.asm.aa).apply(null,arguments)},uo=i._DApi_Char=function(){return(uo=i._DApi_Char=i.asm.ba).apply(null,arguments)},fo=i._DApi_Render=function(){return(fo=i._DApi_Render=i.asm.ca).apply(null,arguments)},eo=i._DApi_SyncText=function(){return(eo=i._DApi_SyncText=i.asm.da).apply(null,arguments)},oo=i._SNet_InitWebsocket=function(){return(oo=i._SNet_InitWebsocket=i.asm.ea).apply(null,arguments)},so=i._SNet_WebsocketStatus=function(){return(so=i._SNet_WebsocketStatus=i.asm.fa).apply(null,arguments)},ho=i._DApi_AllocPacket=function(){return(ho=i._DApi_AllocPacket=i.asm.ga).apply(null,arguments)},rt=i.stackSave=function(){return(rt=i.stackSave=i.asm.ha).apply(null,arguments)},ut=i.stackRestore=function(){return(ut=i.stackRestore=i.asm.ia).apply(null,arguments)},ei=i.stackAlloc=function(){return(ei=i.stackAlloc=i.asm.ja).apply(null,arguments)},vt=i._setThrew=function(){return(vt=i._setThrew=i.asm.ka).apply(null,arguments)},oi=i.___cxa_can_catch=function(){return(oi=i.___cxa_can_catch=i.asm.la).apply(null,arguments)},vr=i.___cxa_is_pointer_type=function(){return(vr=i.___cxa_is_pointer_type=i.asm.ma).apply(null,arguments)};if(nt=function ao(){yt||si();yt||(nt=ao)},i.run=si,i.preInit)for(typeof i.preInit=="function"&&(i.preInit=[i.preInit]);i.preInit.length>0;)i.preInit.pop()();return si(),i.ready=new Promise(function(n,t){delete i.then;i.onAbort=function(n){t(n)};ur(function(){n(i)})}),t.ready}}(),DiabloSpawn;typeof exports=="object"&&typeof module=="object"?module.exports=Diablo:typeof define=="function"&&define.amd?define([],function(){return Diablo}):typeof exports=="object"&&(exports.Diablo=Diablo);DiabloSpawn=function(){var n=typeof document!="undefined"&&document.currentScript?document.currentScript.src:undefined;return typeof __filename!="undefined"&&(n=n||__filename),function(t){function pr(n){return i.locateFile?i.locateFile(n,o):o+n}function wi(n,t){n||v("Assertion failed: "+t)}function bi(n,t,i){for(var h=t+i,u=t,f,r,e,o,s;n[u]&&!(u>=h);)++u;if(u-t>16&&n.subarray&&gt)return gt.decode(n.subarray(t,u));for(f="";t<u;){if(r=n[t++],!(r&128)){f+=String.fromCharCode(r);continue}if(e=n[t++]&63,(r&224)==192){f+=String.fromCharCode((r&31)<<6|e);continue}o=n[t++]&63;r=(r&240)==224?(r&15)<<12|e<<6|o:(r&7)<<18|e<<12|o<<6|n[t++]&63;r<65536?f+=String.fromCharCode(r):(s=r-65536,f+=String.fromCharCode(55296|s>>10,56320|s&1023))}return f}function ct(n,t){return n?bi(u,n,t):""}function kr(n,t){return n%t>0&&(n+=t-n%t),n}function nr(n){ki=n;i.HEAP8=g=new Int8Array(n);i.HEAP16=dr=new Int16Array(n);i.HEAP32=r=new Int32Array(n);i.HEAPU8=u=new Uint8Array(n);i.HEAPU16=gr=new Uint16Array(n);i.HEAPU32=nu=new Uint32Array(n);i.HEAPF32=di=new Float32Array(n);i.HEAPF64=gi=new Float64Array(n)}function ru(){if(i.preRun)for(typeof i.preRun=="function"&&(i.preRun=[i.preRun]);i.preRun.length;)ou(i.preRun.shift());ti(tr)}function uu(){tu=!0;ti(ir)}function fu(){iu=!0}function eu(){if(i.postRun)for(typeof i.postRun=="function"&&(i.postRun=[i.postRun]);i.postRun.length;)ur(i.postRun.shift());ti(rr)}function ou(n){tr.unshift(n)}function su(n){ir.unshift(n)}function ur(n){rr.unshift(n)}function hu(){a++;i.monitorRunDependencies&&i.monitorRunDependencies(a)}function cu(){if(a--,i.monitorRunDependencies&&i.monitorRunDependencies(a),a==0&&(ni!==null&&(clearInterval(ni),ni=null),nt)){var n=nt;nt=null;n()}}function v(n){if(i.onAbort)i.onAbort(n);n+="";l(n);ht=!0;pi=1;n="abort("+n+"). Build with -s ASSERTIONS=1 for more info.";var t=new WebAssembly.RuntimeError(n);pt(t);throw t;}function er(n){return n.startsWith(fr)}function or(n){return n.startsWith("file://")}function sr(n){try{if(n==e&&d)return new Uint8Array(d);if(k)return k(n);throw"both async and sync fetching of the wasm failed";}catch(t){v(t)}}function lu(){if(!d&&(et||c))if(typeof fetch!="function"||or(e)){if(bt)return new Promise(function(n,t){bt(e,function(t){n(new Uint8Array(t))},t)})}else return fetch(e,{credentials:"same-origin"}).then(function(n){if(!n.ok)throw"failed to load wasm binary file at '"+e+"'";return n.arrayBuffer()}).catch(function(){return sr(e)});return Promise.resolve().then(function(){return sr(e)})}function au(){function r(n){var t=n.exports;i.asm=t;st=i.asm.U;nr(st.buffer);w=i.asm.W;su(i.asm.V);cu("wasm-instantiate")}function t(n){r(n.instance)}function u(t){return lu().then(function(t){return WebAssembly.instantiate(t,n)}).then(t,function(n){l("failed to asynchronously prepare wasm: "+n);v(n)})}function f(){return d||typeof WebAssembly.instantiateStreaming!="function"||er(e)||or(e)||typeof fetch!="function"?u(t):fetch(e,{credentials:"same-origin"}).then(function(i){var r=WebAssembly.instantiateStreaming(i,n);return r.then(t,function(n){return l("wasm streaming compile failed: "+n),l("falling back to ArrayBuffer instantiation"),u(t)})})}var n={a:de};if(hu("wasm-instantiate"),i.instantiateWasm)try{return i.instantiateWasm(n,r)}catch(o){return l("Module.instantiateWasm callback failed with error: "+o),!1}return f().catch(pt),{}}function vu(){self.DApi.close_keyboard()}function yu(n,t,i,r,u){self.DApi.open_keyboard(n,t,i,r,u)}function pu(n,t,i){self.DApi.create_sound(n,u.slice(t,t+i))}function wu(n,t,i,r,u){self.DApi.create_sound_raw(n,di.slice(t/4,t/4+i*r),i,r,u)}function bu(n){self.DApi.delete_sound(n)}function ku(){self.DApi.draw_begin()}function du(n){self.DApi.draw_belt(r.subarray(n/4,n/4+8))}function gu(n,t,i,r,f){self.DApi.draw_blit(n,t,i,r,u.subarray(f,f+i*r*4))}function nf(n,t,i,r){self.DApi.draw_clip_text(n,t,i,r)}function tf(){self.DApi.draw_end()}function rf(n,t,i,r){var f=u.indexOf(0,i),e=String.fromCharCode.apply(null,u.subarray(i,f));self.DApi.draw_text(n,t,e,r)}function uf(n,t){self.DApi.duplicate_sound(n,t)}function ff(){self.DApi.exit_game()}function ef(n,t,i,r){self.DApi.play_sound(n,t,i,r)}function of(n,t){self.DApi.set_cursor(n,t)}function sf(n,t){self.DApi.set_volume(n,t)}function hf(n){self.DApi.stop_sound(n)}function cf(n){self.DApi.use_websocket(n)}function lf(){return self.DApi.websocket_closed()}function af(n,t){self.DApi.websocket_send(u.subarray(n,n+t))}function vf(n){var t=u.indexOf(0,n),i=String.fromCharCode.apply(null,u.subarray(n,t));self.DApi.exit_error(i)}function yf(n,t,i,r){var f=u.indexOf(0,n),e=String.fromCharCode.apply(null,u.subarray(n,f));self.DApi.get_file_contents(e,u.subarray(t,t+r),i)}function pf(n){var t=u.indexOf(0,n),i=String.fromCharCode.apply(null,u.subarray(n,t));return self.DApi.get_file_size(i)}function wf(n,t,i){var r=u.indexOf(0,n),f=String.fromCharCode.apply(null,u.subarray(n,r));self.DApi.put_file_contents(f,u.slice(t,t+i))}function bf(n){var t=u.indexOf(0,n),i=String.fromCharCode.apply(null,u.subarray(n,t));self.DApi.remove_file(i)}function ti(n){for(var t,r;n.length>0;){if(t=n.shift(),typeof t=="function"){t(i);continue}r=t.func;typeof r=="number"?t.arg===undefined?w.get(r)():w.get(r)(t.arg):r(t.arg===undefined?null:t.arg)}}function lr(){return yi||cr>0}function kf(n,t,i,r){v("Assertion failed: "+ct(n)+", at: "+[t?ct(t):"unknown filename",i,r?ct(r):"unknown function"])}function df(n){return fi(n+f.SIZE)+f.SIZE}function tt(n){this.excPtr=n;this.ptr=n-f.SIZE;this.set_type=function(n){r[this.ptr+f.TYPE_OFFSET>>2]=n};this.get_type=function(){return r[this.ptr+f.TYPE_OFFSET>>2]};this.set_destructor=function(n){r[this.ptr+f.DESTRUCTOR_OFFSET>>2]=n};this.get_destructor=function(){return r[this.ptr+f.DESTRUCTOR_OFFSET>>2]};this.set_refcount=function(n){r[this.ptr+f.REFCOUNT_OFFSET>>2]=n};this.set_caught=function(n){n=n?1:0;g[this.ptr+f.CAUGHT_OFFSET>>0]=n};this.get_caught=function(){return g[this.ptr+f.CAUGHT_OFFSET>>0]!=0};this.set_rethrown=function(n){n=n?1:0;g[this.ptr+f.RETHROWN_OFFSET>>0]=n};this.get_rethrown=function(){return g[this.ptr+f.RETHROWN_OFFSET>>0]!=0};this.init=function(n,t){this.set_type(n);this.set_destructor(t);this.set_refcount(0);this.set_caught(!1);this.set_rethrown(!1)};this.add_ref=function(){var n=r[this.ptr+f.REFCOUNT_OFFSET>>2];r[this.ptr+f.REFCOUNT_OFFSET>>2]=n+1};this.release_ref=function(){var n=r[this.ptr+f.REFCOUNT_OFFSET>>2];return r[this.ptr+f.REFCOUNT_OFFSET>>2]=n-1,n===1}}function lt(n){this.free=function(){ui(this.ptr);this.ptr=0};this.set_base_ptr=function(n){r[this.ptr>>2]=n};this.get_base_ptr=function(){return r[this.ptr>>2]};this.set_adjusted_ptr=function(n){r[this.ptr+4>>2]=n};this.get_adjusted_ptr=function(){return r[this.ptr+4>>2]};this.get_exception_ptr=function(){var t=vr(this.get_exception_info().get_type()),n;return t?r[this.get_base_ptr()>>2]:(n=this.get_adjusted_ptr(),n!==0)?n:this.get_base_ptr()};this.get_exception_info=function(){return new tt(this.get_base_ptr())};n===undefined?(this.ptr=fi(8),this.set_adjusted_ptr(0)):this.ptr=n}function gf(n){n.add_ref()}function ne(n){var i=new lt(n),t=i.get_exception_info();return t.get_caught()||(t.set_caught(!0),ri--),t.set_rethrown(!1),ii.push(i),gf(t),i.get_exception_ptr()}function ar(n){return ui(new tt(n).ptr)}function te(n){if(n.release_ref()&&!n.get_rethrown()){var t=n.get_destructor();t&&w.get(t)(n.excPtr);ar(n.excPtr)}}function ie(){vt(0);var n=ii.pop();te(n.get_exception_info());n.free();y=0}function re(n){var t=new lt(n),i=t.get_base_ptr();y||(y=i);t.free();throw i;}function ue(){var n=y,f,i,o;if(!n)return h(0),0;var c=new tt(n),u=c.get_type(),t=new lt;if(t.set_base_ptr(n),!u)return h(0),t.ptr|0;var s=Array.prototype.slice.call(arguments),l=rt(),e=ei(4);for(r[e>>2]=n,f=0;f<s.length;f++){if(i=s[f],i===0||i===u)break;if(oi(i,u,e))return o=r[e>>2],n!==o&&t.set_adjusted_ptr(o),h(i),t.ptr|0}return ut(l),h(u),t.ptr|0}function fe(){var n=y,f,i,o;if(!n)return h(0),0;var c=new tt(n),u=c.get_type(),t=new lt;if(t.set_base_ptr(n),!u)return h(0),t.ptr|0;var s=Array.prototype.slice.call(arguments),l=rt(),e=ei(4);for(r[e>>2]=n,f=0;f<s.length;f++){if(i=s[f],i===0||i===u)break;if(oi(i,u,e))return o=r[e>>2],n!==o&&t.set_adjusted_ptr(o),h(i),t.ptr|0}return ut(l),h(u),t.ptr|0}function ee(n,t,i){var r=new tt(n);r.init(t,i);y=n;ri++;throw n;}function oe(){v()}function se(n,t){var f,i;for(at.length=0,t>>=2;f=u[n++];)i=f<105,i&&t&1&&t++,at.push(i?gi[t++>>1]:r[t]),++t;return at}function he(n,t,i){var r=se(t,i);return hr[n].apply(null,r)}function ce(n,t,i){u.copyWithin(n,t,t+i)}function le(n){try{return st.grow(n-ki.byteLength+65535>>>16),nr(st.buffer),1}catch(t){}}function ae(n){var o=u.length,r,t,i,f,e;if(n=n>>>0,r=2147483648,n>r)return!1;for(t=1;t<=4;t*=2)if(i=o*(1+.2/t),i=Math.min(i,n+100663296),f=Math.min(r,kr(Math.max(n,i),65536)),e=le(f),e)return!0;return!1}function ve(n){vo(n)}function ye(){return 0}function pe(){}function we(n,t,i,f){for(var c,s,o,h=0,e=0;e<i;e++){for(c=r[t+e*8>>2],s=r[t+(e*8+4)>>2],o=0;o<s;o++)it.printChar(n,u[c+o]);h+=s}return r[f>>2]=h,0}function be(){return br()}function ke(n){var t=Date.now()/1e3|0;return n&&(r[n>>2]=t),t}function co(n,t,i){var u=rt();try{return w.get(n)(t,i)}catch(r){if(ut(u),r!==r+0&&r!=="longjmp")throw r;vt(1,0)}}function lo(n){var i=rt();try{w.get(n)()}catch(t){if(ut(i),t!==t+0&&t!=="longjmp")throw t;vt(1,0)}}function yr(n){this.name="ExitStatus";this.message="Program terminated with exit("+n+")";this.status=n}function si(n){function t(){yt||(yt=!0,i.calledRun=!0,ht)||(uu(),hi(i),i.onRuntimeInitialized&&i.onRuntimeInitialized(),eu())}(n=n||b,a>0)||(ru(),a>0)||(i.setStatus?(i.setStatus("Running..."),setTimeout(function(){setTimeout(function(){i.setStatus("")},1);t()},1)):t())}function vo(n,t){if(pi=n,!t||!lr()||n!==0){if(!lr()){if(fu(),i.onExit)i.onExit(n);ht=!0}ft(n,new yr(n))}}var i,hi,pt,p,s,o,ot,bt,k,wr,kt,dt,ai,l,yi,st,ht,pi,gt,ki,g,u,dr,gr,r,nu,di,gi,fr,e,hr,cr,f,ii,ri,y,at,it,yt;t=t||{};i=typeof t!="undefined"?t:{};i.ready=new Promise(function(n,t){hi=n;pt=t});p={};for(s in i)i.hasOwnProperty(s)&&(p[s]=i[s]);var b=[],ci="./this.program",ft=function(n,t){throw t;},et=!1,c=!1,wt=!1,li=!1;if(et=typeof window=="object",c=typeof importScripts=="function",wt=typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string",li=!et&&!wt&&!c,o="",wt){o=c?require("path").dirname(o)+"/":__dirname+"/";ot=function(n,t){return kt||(kt=require("fs")),dt||(dt=require("path")),n=dt.normalize(n),kt.readFileSync(n,t?null:"utf8")};k=function(n){var t=ot(n,!0);return t.buffer||(t=new Uint8Array(t)),wi(t.buffer),t};process.argv.length>1&&(ci=process.argv[1].replace(/\\/g,"/"));b=process.argv.slice(2);process.on("uncaughtException",function(n){if(!(n instanceof yr))throw n;});process.on("unhandledRejection",v);ft=function(n){process.exit(n)};i.inspect=function(){return"[Emscripten Module object]"}}else li?(typeof read!="undefined"&&(ot=function(n){return read(n)}),k=function(n){var t;return typeof readbuffer=="function"?new Uint8Array(readbuffer(n)):(t=read(n,"binary"),wi(typeof t=="object"),t)},typeof scriptArgs!="undefined"?b=scriptArgs:typeof arguments!="undefined"&&(b=arguments),typeof quit=="function"&&(ft=function(n){quit(n)}),typeof print!="undefined"&&(typeof console=="undefined"&&(console={}),console.log=print,console.warn=console.error=typeof printErr!="undefined"?printErr:print)):(et||c)&&(c?o=self.location.href:typeof document!="undefined"&&document.currentScript&&(o=document.currentScript.src),n&&(o=n),o=o.indexOf("blob:")!==0?o.substr(0,o.lastIndexOf("/")+1):"",ot=function(n){var t=new XMLHttpRequest;return t.open("GET",n,!1),t.send(null),t.responseText},c&&(k=function(n){var t=new XMLHttpRequest;return t.open("GET",n,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)}),bt=function(n,t,i){var r=new XMLHttpRequest;r.open("GET",n,!0);r.responseType="arraybuffer";r.onload=function(){if(r.status==200||r.status==0&&r.response){t(r.response);return}i()};r.onerror=i;r.send(null)},wr=function(n){document.title=n});ai=i.print||console.log.bind(console);l=i.printErr||console.warn.bind(console);for(s in p)p.hasOwnProperty(s)&&(i[s]=p[s]);p=null;i.arguments&&(b=i.arguments);i.thisProgram&&(ci=i.thisProgram);i.quit&&(ft=i.quit);var vi=0,h=function(n){vi=n},br=function(){return vi},d;i.wasmBinary&&(d=i.wasmBinary);yi=i.noExitRuntime||!0;typeof WebAssembly!="object"&&v("no native wasm support detected");ht=!1;gt=typeof TextDecoder!="undefined"?new TextDecoder("utf8"):undefined;var po=i.INITIAL_MEMORY||134217728,w,tr=[],ir=[],rr=[],tu=!1,iu=!1;var a=0,ni=null,nt=null;i.preloadedImages={};i.preloadedAudios={};fr="data:application/octet-stream;base64,";e="DiabloSpawn.wasm";er(e)||(e=pr(e));hr={264426:function(n){self.DApi.current_save_id(n)}};cr=0;f={DESTRUCTOR_OFFSET:0,REFCOUNT_OFFSET:4,TYPE_OFFSET:8,CAUGHT_OFFSET:12,RETHROWN_OFFSET:13,SIZE:16};ii=[];ri=0;y=0;at=[];it={mappings:{},buffers:[null,[],[]],printChar:function(n,t){var i=it.buffers[n];t===0||t===10?((n===1?ai:l)(bi(i,0)),i.length=0):i.push(t)},varargs:undefined,get:function(){it.varargs+=4;return r[it.varargs-4>>2]},getStr:function(n){return ct(n)},get64:function(n){return n}};var de={v:kf,e:df,A:ne,z:ie,i:ue,l:fe,p:ar,d:ee,h:re,H:vu,I:yu,F:oe,L:pu,O:wu,a:bu,u:ku,P:du,t:gu,S:nf,k:tf,R:rf,M:uf,G:ff,r:ef,Q:of,K:sf,N:hf,m:cf,D:lf,E:af,J:he,x:ce,y:ae,b:ve,o:vf,C:ye,w:pe,q:we,c:be,f:yf,s:pf,j:co,B:lo,g:wf,T:bf,n:ke},wo=au(),ge=i.___wasm_call_ctors=function(){return(ge=i.___wasm_call_ctors=i.asm.V).apply(null,arguments)},ui=i._free=function(){return(ui=i._free=i.asm.X).apply(null,arguments)},fi=i._malloc=function(){return(fi=i._malloc=i.asm.Y).apply(null,arguments)},no=i._DApi_SyncTextPtr=function(){return(no=i._DApi_SyncTextPtr=i.asm.Z).apply(null,arguments)},to=i._DApi_Init=function(){return(to=i._DApi_Init=i.asm._).apply(null,arguments)},io=i._DApi_Mouse=function(){return(io=i._DApi_Mouse=i.asm.$).apply(null,arguments)},ro=i._DApi_Key=function(){return(ro=i._DApi_Key=i.asm.aa).apply(null,arguments)},uo=i._DApi_Char=function(){return(uo=i._DApi_Char=i.asm.ba).apply(null,arguments)},fo=i._DApi_Render=function(){return(fo=i._DApi_Render=i.asm.ca).apply(null,arguments)},eo=i._DApi_SyncText=function(){return(eo=i._DApi_SyncText=i.asm.da).apply(null,arguments)},oo=i._SNet_InitWebsocket=function(){return(oo=i._SNet_InitWebsocket=i.asm.ea).apply(null,arguments)},so=i._SNet_WebsocketStatus=function(){return(so=i._SNet_WebsocketStatus=i.asm.fa).apply(null,arguments)},ho=i._DApi_AllocPacket=function(){return(ho=i._DApi_AllocPacket=i.asm.ga).apply(null,arguments)},rt=i.stackSave=function(){return(rt=i.stackSave=i.asm.ha).apply(null,arguments)},ut=i.stackRestore=function(){return(ut=i.stackRestore=i.asm.ia).apply(null,arguments)},ei=i.stackAlloc=function(){return(ei=i.stackAlloc=i.asm.ja).apply(null,arguments)},vt=i._setThrew=function(){return(vt=i._setThrew=i.asm.ka).apply(null,arguments)},oi=i.___cxa_can_catch=function(){return(oi=i.___cxa_can_catch=i.asm.la).apply(null,arguments)},vr=i.___cxa_is_pointer_type=function(){return(vr=i.___cxa_is_pointer_type=i.asm.ma).apply(null,arguments)};if(nt=function ao(){yt||si();yt||(nt=ao)},i.run=si,i.preInit)for(typeof i.preInit=="function"&&(i.preInit=[i.preInit]);i.preInit.length>0;)i.preInit.pop()();return si(),i.ready=new Promise(function(n,t){delete i.then;i.onAbort=function(n){t(n)};ur(function(){n(i)})}),t.ready}}();typeof exports=="object"&&typeof module=="object"?module.exports=DiabloSpawn:typeof define=="function"&&define.amd?define([],function(){return DiabloSpawn}):typeof exports=="object"&&(exports.DiabloSpawn=DiabloSpawn);class Helper{}Helper.fromUint8ArrayToBase64=n=>base64js.fromByteArray(n);Helper.onError=(n,t="error")=>{n instanceof Error?alert(`Action: ${t} Error: ${n.toString()} Stack: ${n.stack}`):alert(`Action: ${t} Error: ${n.toString()}`)};Helper.tryApi=n=>{try{n()}catch(t){Helper.onError(t)}};class Graphics{constructor(){this.initGraphics=n=>{const t=document.getElementById("canvas");this.context=n?t.getContext("bitmaprenderer"):t.getContext("2d",{alpha:!1})};this.drawBegin=()=>{this.renderBatch={images:[],text:[],clip:null}};this.drawEnd=()=>{this.onRender(),this.renderBatch=null};this.drawBlit=(n,t,i,r,u)=>{this.renderBatch.images.push({x:n,y:t,width:i,height:r,data:u.slice()})};this.drawClipText=(n,t,i,r)=>{this.renderBatch.clip={x0:n,y0:t,x1:i,y1:r}};this.drawText=(n,t,i,r)=>{this.renderBatch.text.push({x:n,y:t,text:i,color:r})};this.drawBelt=()=>{};this.onRender=()=>{if(this.context instanceof ImageBitmapRenderingContext)this.context.transferFromImageBitmap(this.renderBatch.bitmap);else if(this.context instanceof CanvasRenderingContext2D){const n=this.context;for(let t of this.renderBatch.images){const i=n.createImageData(t.width,t.height);i.data.set(t.data);n.putImageData(i,t.x,t.y)}if(this.renderBatch.text.length){if(n.save(),n.font="bold 13px Times New Roman",this.renderBatch.clip){const t=this.renderBatch.clip;n.beginPath();n.rect(t.x0,t.y0,t.x1-t.x0,t.y1-t.y0);n.clip()}for(let t of this.renderBatch.text){const i=t.color>>16&255,r=t.color>>8&255,u=t.color&255;n.fillStyle=`rgb(${i}, ${r}, ${u})`;n.fillText(t.text,t.x,t.y)}n.restore()}}};windowAny.DApi.draw_begin=this.drawBegin;windowAny.DApi.draw_end=this.drawEnd;windowAny.DApi.draw_blit=this.drawBlit;windowAny.DApi.draw_clip_text=this.drawClipText;windowAny.DApi.draw_text=this.drawText;windowAny.DApi.draw_belt=this.drawBelt}}class Sound{constructor(){this.initSound=()=>{const n=window.AudioContext||windowAny.webkitAudioContext;if(n){this.context=null;try{this.context=new n}catch(t){}this.sounds=new Map}};this.createSound=(n,t)=>{if(this.context){const i=this.decodeAudioData(this.context,t.buffer);this.sounds.set(n,{buffer:i,gain:this.context.createGain(),panner:StereoPannerNode&&new StereoPannerNode(this.context,{pan:0})})}};this.createSoundRaw=(n,t,i,r,u)=>{if(this.context){const f=this.context.createBuffer(r,i,u);for(let n=0;n<r;++n)f.getChannelData(n).set(t.subarray(n*i,n*i+i));this.sounds.set(n,{buffer:Promise.resolve(f),gain:this.context.createGain(),panner:StereoPannerNode&&new StereoPannerNode(this.context,{pan:0})})}};this.duplicateSound=(n,t)=>{if(this.context){const i=this.sounds.get(t);i&&this.sounds.set(n,{buffer:i.buffer,gain:this.context.createGain(),panner:StereoPannerNode&&new StereoPannerNode(this.context,{pan:0})})}};this.playSound=(n,t,i,r)=>{const u=this.sounds.get(n);if(u){u.source&&u.source.then(n=>n.stop());u.gain.gain.value=Math.pow(2,t/1e3);const n=Math.pow(2,i/1e3);u.panner&&(u.panner.pan.value=1-2/(1+n));u.source=u.buffer.then(n=>{const t=this.context.createBufferSource();t.buffer=n;t.loop=!!r;let i=t.connect(u.gain);return u.panner&&(i=i.connect(u.panner)),i.connect(this.context.destination),t.start(),t})}};this.stopSound=n=>{const t=this.sounds.get(n);t&&t.source&&(t.source.then(n=>n.stop()),delete t.source)};this.deleteSound=n=>{const t=this.sounds.get(n);t&&t.source&&t.source.then(n=>n.stop());this.sounds.delete(n)};this.setVolume=(n,t)=>{const i=this.sounds.get(n);i&&(i.gain.gain.value=Math.pow(2,t/1e3))};this.decodeAudioData=(n,t)=>new Promise((i,r)=>{n.decodeAudioData(t,i,r)});windowAny.DApi.create_sound=this.createSound;windowAny.DApi.create_sound_raw=this.createSoundRaw;windowAny.DApi.play_sound=this.playSound;windowAny.DApi.stop_sound=this.stopSound;windowAny.DApi.delete_sound=this.deleteSound;windowAny.DApi.duplicate_sound=this.duplicateSound;windowAny.DApi.set_volume=this.setVolume}}class Progress{constructor(n,t,i){this.message=n;this.bytesLoaded=t;this.total=i}}class Webassembly{constructor(){this.initWebAssemblyUnmarshalledBegin=async(n,t,i)=>{const r=windowAny.Module.HEAPU8.subarray(t,t+i);this.wasm=await(n?DiabloSpawn:Diablo)({wasmBinary:r});getInterop().dotNetReference.invokeMethodAsync("InitWebAssemblyUnmarshalledEnd")};this.dapiInit=(n,t,i,r,u)=>{this.wasm&&this.wasm._DApi_Init(n,t,i,r,u)};this.dapiMouse=(n,t,i,r,u)=>{this.wasm&&this.wasm._DApi_Mouse(n,t,i,r,u)};this.dapiKey=(n,t,i)=>{this.wasm&&this.wasm._DApi_Key(n,t,i)};this.dapiChar=n=>{this.wasm&&this.wasm._DApi_Char(n)};this.callApi=(n,...t)=>{this.wasm&&Helper.tryApi(()=>{if(n!=="text")this.wasm["_"+n](...t);else{const n=this.wasm._DApi_SyncTextPtr(),i=t[0],r=Math.min(i.length,255),u=this.wasm.HEAPU8;for(let t=0;t<r;++t)u[n+t]=i.charCodeAt(t);u[n+r]=0;this.wasm._DApi_SyncText(t[1])}})}}}class FileStore{constructor(){this.initIndexedDb=async()=>{this.store=new IdbKvStore("diablo_fs");for(let[n,t]of Object.entries(await this.store.json()))this.files.set(n.toLowerCase(),t)};this.updateIndexedDbFromUint8Array=async(n,t)=>{await this.store.set(n,t)};this.readIndexedDb=async n=>{const t=await this.store.get(n.toLowerCase());return Helper.fromUint8ArrayToBase64(t)};this.indexedDbHasFile=async n=>{const t=await this.store.get(n.toLowerCase());return t?!0:!1};this.storeSpawnUnmarshalledBegin=async(n,t)=>{const u=windowAny.Module.HEAPU8.subarray(n,n+t),i=new Uint8Array(u),r="spawn.mpq";await this.store.set(r,i);this.files.set(r,i);getInterop().dotNetReference.invokeMethodAsync("StoreSpawnUnmarshalledEnd")};this.readFile=n=>new Promise((t,i)=>{const r=new FileReader;r.onload=()=>t(r.result);r.onerror=()=>i(r.error);r.onabort=()=>i();r.onprogress=n=>getInterop().dotNetReference.invokeMethodAsync("OnProgress",new Progress("Loading...",n.loaded,n.total));r.readAsArrayBuffer(n)});this.getFileFromInput=async n=>{const i=document.getElementById(n),t=i.files[0],r=t.name.toLowerCase(),u=new Uint8Array(await this.readFile(t));return{name:r,data:u}};this.isDropFile=n=>{const t=n.dataTransfer.items;if(t)for(let n=0;n<t.length;++n)if(t[n].kind==="file")return!0;return n.dataTransfer.files.length?!0:!1};this.onDropFile=n=>{this.dropFile=this.getDropFile(n),this.dropFile&&(n.preventDefault(),getInterop().dotNetReference.invokeMethodAsync("Start",this.dropFile.name.toLowerCase(),!0))};this.getDropFile=n=>{const t=n.dataTransfer.items;if(t)for(let n=0;n<t.length;++n)if(t[n].kind==="file")return t[n].getAsFile();const i=n.dataTransfer.files;if(i.length)return i[0]};this.setDropFile=async()=>{const n=new Uint8Array(await this.readFile(this.dropFile));this.files.set(this.dropFile.name.toLowerCase(),n);this.dropFile=null};this.setInputFile=async()=>{const n=await this.getFileFromInput("mpqInput");this.files.set(n.name,n.data)};this.uploadFile=async()=>{const n=await this.getFileFromInput("saveInput");this.files.set(n.name,n.data);this.store.set(n.name,n.data)};this.hasFile=(n,t)=>{const i=this.files.get(n.toLowerCase());return i?t.length>0?t.includes(i.byteLength):!0:!1};this.getFilenames=()=>[...this.files.keys()];this.getFilesize=n=>{const t=this.files.get(n.toLowerCase());return t?t.byteLength:0};this.getFileContents=(n,t,i)=>{const r=this.files.get(n.toLowerCase());r&&t.set(r.subarray(i,i+t.byteLength))};this.putFileContents=async(n,t)=>{n=n.toLowerCase(),this.files.set(n,t),await this.updateIndexedDbFromUint8Array(n,t)};this.removeFile=async n=>{n=n.toLowerCase(),this.files.delete(n),await this.store.remove(n)};this.getRenderInterval=()=>{const n=localStorage.getItem("DiabloRenderInterval");return n?parseInt(n):50};this.setRenderInterval=n=>{localStorage.setItem("DiabloRenderInterval",n.toString())};this.files=new Map;windowAny.DApi.get_file_size=this.getFilesize;windowAny.DApi.get_file_contents=this.getFileContents;windowAny.DApi.put_file_contents=this.putFileContents;windowAny.DApi.remove_file=this.removeFile}}class Interop{constructor(){this.setDotNetReference=n=>{this._dotNetReference=n};this.addEventListeners=()=>{window.addEventListener("resize",()=>this._dotNetReference.invokeMethodAsync("OnResize",this.getCanvasRect()));const n=document.getElementById("main");n.addEventListener("drop",n=>this._fileStore.onDropFile(n));n.addEventListener("dragover",n=>{this._fileStore.isDropFile(n)&&n.preventDefault()});this.canvas.addEventListener("keydown",n=>{(n.keyCode===8||n.keyCode===9||n.keyCode>=112&&n.keyCode<=119)&&n.preventDefault()});this.canvas.addEventListener("contextmenu",n=>n.preventDefault())};this.getCanvasRect=()=>this.canvas.getBoundingClientRect();this.openKeyboard=()=>{};this.closeKeyboard=()=>{};this.exitError=n=>{throw Error(n);};this.exitGame=()=>{this._dotNetReference.invokeMethodAsync("OnExit")};this.currentSaveId=n=>{this._dotNetReference.invokeMethodAsync("SetSaveName",n)};this.setCursor=(n,t)=>{this._webassembly.dapiMouse(0,0,0,n,t)};this.reload=()=>{window.location.reload()};this.clickDownloadLink=(n,t,i)=>{n.setAttribute("download",t),n.setAttribute("href",i),n.click(),n.removeAttribute("download"),n.removeAttribute("href")};this._webassembly=new Webassembly;this._graphics=new Graphics;this._sound=new Sound;this._fileStore=new FileStore;windowAny.DApi.open_keyboard=this.openKeyboard;windowAny.DApi.close_keyboard=this.closeKeyboard;windowAny.DApi.set_cursor=this.setCursor;windowAny.DApi.current_save_id=this.currentSaveId;windowAny.DApi.exit_game=this.exitGame;windowAny.DApi.exit_error=this.exitError}get webassembly(){return this._webassembly}get graphics(){return this._graphics}get sound(){return this._sound}get fileStore(){return this._fileStore}get canvas(){return this._canvas||(this._canvas=document.getElementById("canvas")),this._canvas}get dotNetReference(){return this._dotNetReference}}const windowAny=window;windowAny.DApi={};windowAny.interop=new Interop;const getInterop=()=>windowAny.interop;